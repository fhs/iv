<!doctype html>
<html>

<head>
<meta charset="utf-8" />
<link rel="shortcut icon" href="favicon.ico">
<title>Image Viewer</title>
<style>
.granule {
	text-align: center;
	background-color: #eeeeee;
	border-style: solid;
	border-color: #dddddd;
	padding-left: 5px;
	padding-right: 5px;
	padding-bottom: 5px;
}

.dirinputform {
	text-align: center;
}

.hidden {
	display: none;
}

.error {
	text-align: center;
	color: #D8000C;
}

img {
	display: block;
	margin-left: auto;
	margin-right: auto;
	max-width: 100%;
}
</style>
</head>

<body>
<form class="dirinputform">
	<input type="text" name="d" id="dirinput" size="50", placeholder="Directory">
	<input type="submit" value="Submit"><br />
</form>
<br />

<div class="error">
<div id="error_targ"></div>
</div>

<script id="ajaxerror_templ" type="text/template">
	<p>problem getting {{dir}}<br />
	Error: {{errorThrown}}<br />
	Status: {{status}}<br />
	</p>
</script>
<div id="ajaxerror_targ"></div>

<script id="dirs_templ" type="text/template">
	{{#dirs.length}}
		Subdirectories:
		<ul>
		{{#dirs}}
			<li><a href="?d={{url}}">{{filename}}</a></li>
		{{/dirs}}
		</ul>
	{{/dirs.length}}
</script>
<div id="dirs_targ"></div>

<script id="granule_templ" type="text/template">
	{{#granules.length}}
		<p>
		<div id="shortlist">
			Images:
			{{#granules}}
				<a href="#{{count}}" title="{{filename}}">{{count}}</a>
			{{/granules}}
			<button onclick="showFilenames()">Show filenames</button>
		</div>
		<div id="longlist" class="hidden">
			Images:
			<ol>
			{{#granules}}
				<li><a href="#{{count}}">{{filename}}</a></li>
			{{/granules}}
			</ol>
			<button onclick="hideFilenames()">Hide filenames</button>
		</div>
		</p>

		{{#granules}}
		<div class="granule">
			<a name="{{count}}"></a> 
			<h3 class="title">{{count}}. {{filename}}</h3>
			<a href="{{url}}"><img src="{{url}}" /></a>
		</div>
		<br />
		{{/granules}}
	{{/granules.length}}
</script>
<div id="granules_targ"></div>


<script src="jquery-2.1.1.min.js"></script>
<script src="mustache.js"></script>
<script src="URI.js"></script>
<script>
 
// Read a page's GET URL variables and return them as an associative array.
function getURLVars() {
	var vars = [];
	var pair, pairs;
	var href = window.location.href;
	var hash = href.indexOf('#');

	if (hash < 0){
		pairs = href.slice(href.indexOf('?')+1).split('&');
	} else {
		pairs = href.slice(href.indexOf('?')+1, hash).split('&');
	}
	for(var i = 0; i < pairs.length; i++) {
		pair = pairs[i].split('=');
		vars.push(pair[0]);
		vars[pair[0]] = pair[1];
	}
	return vars;
}

function showFilenames() {
	$("#shortlist").hide("fast");
	$("#longlist").show("fast");
}

function hideFilenames() {
	$("#longlist").hide("fast");
	$("#shortlist").show("fast");
}

function fatal(msg) {
	$("#error_targ").replaceWith(msg);
}

$(document).ready(function() {
	var queries = getURLVars();
	if (!queries["d"]) {
		fatal("No directory specified.");
		return;
	}
	var dir = decodeURIComponent(queries["d"]);
	if (dir.slice(-1) !== "/") {
		dir += "/"
	}
	dir = URI(dir).normalizePathname().toString();
	if (!dir || dir.length === 0) {
		fatal("No directory specified.");
		return;
	}

	$.ajax({
		url: dir,
		data: {},
		type: "GET",
		dataType: "html",
		success: function(resp) {
			$("#dirinput").val(dir);

			var count = 0;
			granules = [];
			dirs = [];
			$(resp).find("a").each(function() {
				var filename = $(this).attr("href");
				if (filename.match(/png$/)) {
					granules.push({
						count: count+1,
						filename: filename,
						url: dir+filename,
					});
					count++;
				}
				if (filename.match(/\/$/)) {
					dirs.push({
						filename: filename,
						url: dir+filename,
					});
				}
			});

			granule_templ = $("#granule_templ").html();
			Mustache.parse(granule_templ);
			$("#granules_targ").html(Mustache.render(granule_templ, {
				granules: granules,
			}));

			dirs_templ = $("#dirs_templ").html();
			Mustache.parse(dirs_templ);
			$("#dirs_targ").html(Mustache.render(dirs_templ, {
				dirs: dirs,
			}));

			if (count == 0) {
				fatal("No images found. Look inside subdirectories.");
				return;
			}
		},
		error: function(xhr, status, errorThrown) {
			ajaxerror_templ = $("#ajaxerror_templ").html();
			Mustache.parse(ajaxerror_templ);
			$("#ajaxerror_targ").html(Mustache.render(ajaxerror_templ, {
				dir: dir,
				errorThrown: errorThrown,
				status: status,
			}));
		},
	});
});
 
</script>

</body>
</html>
