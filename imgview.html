<!doctype html>
<html>

<head>
<meta charset="utf-8" />
<link rel="shortcut icon" href="favicon.ico">
<title>Image Viewer</title>
<style>
.granule {
	text-align: center;
	background-color: #eeeeee;
	border-style: solid;
	border-color: #dddddd;
}
</style>
</head>

<body>
<form>Directory (e.g.
	<a href="?d=out/acspo/R20140710/">out/acspo/R20140710/</a>):<br />
	<input type="text" name="d" id="dirinput" size="70">
	<input type="submit" value="Submit"><br />
</form>
<br />

<div id="error_targ"></div>

<script id="ajaxerror_templ" type="text/template">
	<p>problem getting {{dir}}<br />
	Error: {{errorThrown}}<br />
	Status: {{status}}<br />
	</p>
</script>
<div id="ajaxerror_targ"></div>

<script id="granule_templ" type="text/template">
	{{#granules.length}}
		<p>Images:
		{{#granules}}
			<a href="#{{count}}">{{count}}</a>
		{{/granules}}
		</p>
		{{#granules}}
		<div class="granule">
			<a name="{{count}}"></a> 
			<h3 class="title">{{count}}) {{filename}}</h3>
			<a href="{{url}}"><img src="{{url}}" /></a>
			<br/>
		</div>
		<br />
		{{/granules}}
	{{/granules.length}}
</script>
<div id="granules_targ"></div>


<script src="jquery-2.1.1.js"></script>
<script src="mustache.js"></script>
<script>
 
// Read a page's GET URL variables and return them as an associative array.
function getURLVars() {
	var vars = [];
	var pair, pairs;
	var href = window.location.href;
	var hash = href.indexOf('#');

	if (hash < 0){
		pairs = href.slice(href.indexOf('?')+1).split('&');
	} else {
		pairs = href.slice(href.indexOf('?')+1, hash).split('&');
	}
	for(var i = 0; i < pairs.length; i++) {
		pair = pairs[i].split('=');
		vars.push(pair[0]);
		vars[pair[0]] = pair[1];
	}
	return vars;
}

$(document).ready(function() {
	var queries = getURLVars();
	if (!queries["d"]) {
		$("#error_targ").replaceWith("no directory specified");
		return;
	}
	var dir = decodeURIComponent(queries["d"]);
	$.ajax({
		url: dir,
		data: {},
		type: "GET",
		dataType: "html",
		success: function(resp) {
			$("#dirinput").val(dir);

			var count = 0;
			granules = [];
			$(resp).find("a").each(function() {
				var filename = $(this).attr("href");
				if (filename.match(/png$/)) {
					granules.push({
						count: count+1,
						filename: filename,
						url: dir+filename,
					});
					count++;
				}
			});

			granule_templ = $("#granule_templ").html();
			Mustache.parse(granule_templ);
			$("#granules_targ").html(Mustache.render(granule_templ, {
				granules: granules,
			}));

			if (count == 0) {
				$("#error_targ").replaceWith("no images found");
				return;
			}
		},
		error: function(xhr, status, errorThrown) {
			ajaxerror_templ = $("#ajaxerror_templ").html();
			Mustache.parse(ajaxerror_templ);
			$("#ajaxerror_targ").html(Mustache.render(ajaxerror_templ, {
				dir: dir,
				errorThrown: errorThrown,
				status: status,
			}));
		},
	});
});
 
</script>

</body>
</html>
